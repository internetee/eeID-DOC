
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Estonian Internet Foundation's eeID Documentation</title>

    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sa {
  color: #6c71c4;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <link href="stylesheets/screen-a98d7b59.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-953e3353.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-b12a2749.js"></script>

    <script>
      $(function() { setupCodeCopy(); });
    </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-beb0176d.png" class="logo" alt="" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#openid-connect" class="toc-h1 toc-link" data-title="OpenID Connect">OpenID Connect</a>
          </li>
          <li>
            <a href="#getting-started" class="toc-h1 toc-link" data-title="Getting started">Getting started</a>
          </li>
          <li>
            <a href="#authentication-scope" class="toc-h1 toc-link" data-title="Authentication scope">Authentication scope</a>
          </li>
          <li>
            <a href="#requests" class="toc-h1 toc-link" data-title="Requests">Requests</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#authentication-request" class="toc-h2 toc-link" data-title="Authentication request">Authentication request</a>
                  </li>
                  <li>
                    <a href="#redirect-request" class="toc-h2 toc-link" data-title="Redirect request">Redirect request</a>
                  </li>
                  <li>
                    <a href="#identity-token-request" class="toc-h2 toc-link" data-title="Identity token request">Identity token request</a>
                  </li>
                  <li>
                    <a href="#user-info-request" class="toc-h2 toc-link" data-title="User info request">User info request</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#protection" class="toc-h1 toc-link" data-title="Protection">Protection</a>
          </li>
          <li>
            <a href="#endpoints-and-timeouts" class="toc-h1 toc-link" data-title="Endpoints and timeouts">Endpoints and timeouts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#production-service" class="toc-h2 toc-link" data-title="Production service">Production service</a>
                  </li>
                  <li>
                    <a href="#test-service" class="toc-h2 toc-link" data-title="Test service">Test service</a>
                  </li>
                  <li>
                    <a href="#timeouts" class="toc-h2 toc-link" data-title="Timeouts">Timeouts</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#testing" class="toc-h1 toc-link" data-title="Testing">Testing</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#mobile-id" class="toc-h2 toc-link" data-title="Mobile ID">Mobile ID</a>
                  </li>
                  <li>
                    <a href="#smart-id" class="toc-h2 toc-link" data-title="Smart ID">Smart ID</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#run-in-postman" class="toc-h1 toc-link" data-title="Run in Postman">Run in Postman</a>
          </li>
          <li>
            <a href="#code-examples" class="toc-h1 toc-link" data-title="Code examples">Code examples</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#openid-connect-client-with-spring-security" class="toc-h2 toc-link" data-title="OpenID Connect Client with Spring Security">OpenID Connect Client with Spring Security</a>
                  </li>
                  <li>
                    <a href="#php-openid-connect-example" class="toc-h2 toc-link" data-title="PHP OpenID Connect example">PHP OpenID Connect example</a>
                  </li>
                  <li>
                    <a href="#rails-on-rails-with-omniauth-openidconnect" class="toc-h2 toc-link" data-title="Rails on Rails with OmniAuth::OpenIDConnect">Rails on Rails with OmniAuth::OpenIDConnect</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://internet.ee'>Estonian Internet Foundation</a></li>
            <li><a href='https://eeid.ee'>Sign Up for eeID</a></li>
            <li><a href='https://github.com/slatedocs/slate'>Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to the Estonian Internet Foundation&#39;s eeID documentation! This document describes the technical characteristics of the Estonian Internet Foundation eeID authentication service and includes advice for interfacing the client application with e-services. The eeID authentication service can be used by institutions and private persons to add the support of various different <a href="#authentication-methods">authentication methods</a> to its e-service:</p>

<ul>
<li>Mobiil-ID</li>
<li>ID card</li>
<li>Smart-ID</li>
<li>EU-citizen cross-border authentication (i.e. via eIDAS-Node)</li>
<li>FIDO2 Web Authentication (WebAuthn)</li>
</ul>
<h1 id='openid-connect'>OpenID Connect</h1>
<p>The eeID authentication service is based on the OpenID Connect protocol (OIDC), which is built on top of the OAuth 2.0 authorization framework. It&#39;s designed to provide a secure and standardized way to authenticate users and obtain their basic profile information. OIDC is commonly used in applications that require user authentication, such as web and mobile applications.</p>

<p>Limited subset from standards was chosen and some adjustments were made. The main selections and adjustments compared to the full OpenID Connect protocol are the following:</p>

<ul>
<li>The service supports the authorisation code flow. The authorisation code flow is deemed the most secure option and is thus appropriate for public services.</li>
<li>All information about an authenticated user is transferred to the application in an ID token.</li>
<li>The eIDAS assurance level is also transferred to the application if it is known (in the acr statement).</li>
<li>The authentication method is selected by the user in the authentication service or by the interfaced client with the scope parameter.</li>
<li>Cross-border authentication based on the technical specification of eIDAS.</li>
<li>Dynamic registration of the client application is not supported. The client application is registered in <a href="https://eeid.ee">eeID manager</a> by a separate procedure.</li>
</ul>
<h1 id='getting-started'>Getting started</h1>
<p>In order to get started you have to sign up and create your first service in the <a href="https://eeid.ee">eeID manager</a>. </p>

<ol>
<li><p>Add a new contact first. From the main menu select <code>Contacts</code> to go to the contacts management view. Click on + Create New Contact and fill in the form.
<img src="images/new_contact_form-5e7dd36c.png" alt="Create New Contact" /></p></li>
<li><p>From the main menu select <code>Services</code> to go to the service management view. Click on + Create New Service.
<img src="images/create_new_service-c48559cb.png" alt="Create New Service" /></p></li>
<li><p>Fill in the form
<img src="images/new_service_form-9f1e4118.png" alt="New Service Form" /></p></li>
<li><p>All the fields must be valid to proceed.</p></li>
</ol>

<ul>
<li>Name - enter the name for your service. This will ultimately appear in-front of your customers</li>
<li>Description - provide a brief description of your service. It should be concise, ideally one sentence.</li>
<li>Approval description - in this field, provide details about what you are building and who your target customers are.</li>
<li>Redirection URL - specify the URL where users should be redirected to after they have been authenticated. If you do not know what you will use, just enter <code>http://localhost/callback</code> for now. The value can be changed later if needed. NB! Ensure that redirect URL uses the HTTPS protocol. HTTP is only permitted for local development environments (e.g., localhost).</li>
<li>Environment - indicate the environment in which you will be using the service. <code>Test</code> is free and used for testing purposes.</li>
<li>Authentication scope - choose the authentication scope you wish to support. The following scopes are supported: <code>openid</code>, <code>webauthn</code>, <code>phone</code> and <code>email</code>. NB! <code>idcard</code>, <code>mid</code>, <code>smartid</code> and <code>eidas</code> are no longer in use and will be removed.</li>
<li>Authentication methods - choose the authentication methods you wish to support. You can select one or more methods based on your preferred country.</li>
<li>Contact - choose an existing contact or create a new one. This contact will be associated with the service, and it might be the point of contact for any communications or notifications regarding the service.</li>
<li>Consent screen - configure it to skip the &quot;consent screen&quot;, which is the screen where the user must explicitly agree to giving the service access to their data and allow perform operations on their behalf.</li>
<li>Choose logo - upload a logo for your service.</li>
<li>Submission - review all the details entered in the form, and if everything is correct, click on <code>SUBMIT FOR APPROVAL</code> to submit your service.</li>
</ul>

<p>Once you submit the form, it will be reviewed by the service administrators
at the <a href="https://www.internet.ee/">Estonian Internet Foundation</a>
They will assess the details provided in your application to ensure
they meet the necessary criteria and adhere to the <a href="https://meedia.internet.ee/files/Terms_of_use_eeID.pdf">terms of use</a>.
If your application meets all the requirements, it will be approved and you will be provided with the client ID and secret.
In case there are issues or discrepancies in your application, it might be rejected.
After the review process is completed, you will receive a notification regarding the
status of your application. This notification will inform you whether your application has
been approved or rejected.</p>
<h1 id='authentication-scope'>Authentication scope</h1>
<p>By default, the eeID service facilitates the following authentication scope:</p>

<ul>
<li><p><code>openid</code> - compulsory (required by the OpenID Connect protocol).</p></li>
<li><p><code>webauthn</code> authentication scope enables a robust and secure user authentication process grounded
in public key cryptography. This method does away with the need for passwords,
instead allowing users to employ local authenticators such as biometrics or 
security keys to securely and conveniently access online services.
Being a core component of the <a href="https://fidoalliance.org/fido2-2/fido2-web-authentication-webauthn/">FIDO Alliance&#39;s FIDO2</a> set of specifications,
it is designed to foster stronger and simpler web authentication mechanisms,
enhancing security and user experience in the digital landscape.</p></li>
</ul>

<p>For a demo of WebAuthn, visit <a href="https://webauthn.io/">https://webauthn.io/</a>.</p>

<p><b>Creating a WebAuthn Credential through eeID:</b></p>

<ol>
<li><p><b>Initial Authentication</b>
<br>Before creating a WebAuthn credential, the users must first verify their identity
using one of the authentication methods provided in the eeID service or an AI-powered identity verification platform. This crucial step ensures that the user’s identity is securely verified through a recognized and trusted authentication method.</p></li>
<li><p><b>eeID as Identity Provider</b>
<br>Once the initial authentication is successful, the eeID service acts as an identity provider.
In this role, it verifies and stores the authenticated data, establishing a secure and
trusted identity framework for the user.</p></li>
<li><p><b>Creating the Webauthn Credential</b>
<br>Following the successful authentication through eeID,
the user can proceed to create a WebAuthn credential. This process involves:</p>

<ul>
<li><b>Registering a Local Authenticator.</b> The user will register a local authenticator,
such as a biometric identifier (fingerprint, facial recognition, etc.) or a security key.</li>
<li><b>Public Key Cryptography.</b> The WebAuthn method leverages public key cryptography,
where a private key is stored on the user&#39;s local device, and a public key is
stored on the server. This setup ensures a secure and password-less authentication process.</li>
<li><b>Credential ID.</b> Upon successful registration, a unique Credential ID is generated, which will be used for future authentications.</li>
</ul></li>
<li><p><b>Future Authentications</b>
<br>With the WebAuthn credential created, the user can now use this method for future authentications. When logging in:</p>

<ul>
<li>The user will be prompted to authenticate using their local authenticator.</li>
<li>The server verifies the authentication using the stored public key, ensuring a secure and swift login process.</li>
</ul></li>
</ol>

<p>Creating a WebAuthn credential through the eeID service not only enhances the security of
online transactions but also offers a user-friendly authentication experience.
It represents a forward step in secure, password-less digital authentication,
promoting ease of use without compromising on security.</p>

<ul>
<li><code>phone</code> - can be used to request the user’s phone number in the identity token. This option is targeted for client applications that use i.e Mobile-ID, which requires user’s phone number for input, as a means for giving digital signatures. The claims <code>phone</code> and <code>phone_number_verified</code> are issued in the identity token. For example:</li>
</ul>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="s2">"sub"</span>: <span class="s2">"EE60001019906"</span>,
<span class="s2">"phone_number"</span>: <span class="s2">"+37200000766"</span>,
<span class="s2">"phone_number_verified"</span>: <span class="nb">true</span>
</code></pre></div>
<ul>
<li><code>email</code> - can be used to request the user’s e-mail address in the identity token. This option is targeted for the client applications that require verification of an e-mail address in authentication of a user. The claims <code>email</code> and <code>email_verified</code> are issued in the identity token. For example:</li>
</ul>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="s2">"sub"</span>: <span class="s2">"EE60001019906"</span>,
<span class="s2">"email"</span>: <span class="s2">"60001019906@eesti.ee"</span>,
<span class="s2">"email_verified"</span>: <span class="nb">false</span>
</code></pre></div><h1 id='requests'>Requests</h1><h2 id='authentication-request'>Authentication request</h2>
<p>An authentication request is a HTTP GET request by which the user is redirected from the client application to the eeID server for authentication.</p>

<p>URL: <code>https://auth.eeid.ee/hydra-public/oauth2/auth</code></p>

<p>Required query parameters:</p>

<ul>
<li><code>client_id</code> - service identifier issued upon registration of the client application in eeID portal</li>
<li><code>state</code> - security code against false request attacks (cross-site request forgery CSRF)</li>
<li><code>redirect_uri</code> - redirect_uri</li>
<li><code>response_type</code> - determines the manner of communication of the authentication result to the server, must be equal to <code>code</code></li>
<li><code>scope</code> - authentication scope. The scope must correspond to the authentication scope selected while registering the service.</li>
</ul>

<p>Optional query parameters:</p>

<ul>
<li><code>ui_locales</code> - selection of the user interface language. The following languages are supported: <code>et</code>, <code>en</code>, <code>ru</code></li>
<li><code>nonce</code> - unique parameter which helps to prevent replay attacks based on the protocol</li>
</ul>

<p>An example of an authentication request:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>GET https://auth.eeid.ee/hydra-public/oauth2/auth?client_id<span class="o">=</span>oidc-b8ab3705-c25f-4271-b87d-ecf190aa4982-11
&amp;redirect_uri<span class="o">=</span>https%3A%2F%2Feservice.institution.ee%2Fcallback
&amp;response_type<span class="o">=</span>code
&amp;scope<span class="o">=</span>openid%20webauthn
&amp;state<span class="o">=</span>f3b2c3e7f4cf0bed3a783ed6ece617e3
</code></pre></div><h2 id='redirect-request'>Redirect request</h2>
<p>The redirect request is a HTTP GET request which is used to redirect the user back to the return address entered upon registration of the client application in <a href="https://eeid.ee">eeID manager</a>. In the redirect request an authorization code is sent to the client application, based on which the client application will request the access token in order to get personal identification code, name and other attributes of the authenticated person. The security code state received in the authentication request is mirrored back. Read more about forming and verifying state from <a href="#protection">Protection against false request attacks</a>.</p>

<p>An example of a redirect request:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>GET https://eservice.institution.ee/callback?code<span class="o">=</span>71ed5797c3d957817d31&amp;
<span class="nv">state</span><span class="o">=</span>OFfVLKu0kNbJ2EZk
</code></pre></div>
<p><br>
Request might contain other URL parameters, that client application must ignore.</p>

<p>If eeID is unable to process an authentication request - there will be an error in the request. eeID transfers an error message (URL parameter <code>error</code>) and the description of the error (URL parameter <code>error_description</code>) in the redirect request:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>GET https://eservice.institution.ee/callback?error<span class="o">=</span>invalid_scope&amp;error_description<span class="o">=</span>
The+requested+scope+is+invalid%2C+unknown%2C+or+malformed.+The+OAuth+2.0+Client+is+not+allowed+to+request+scope+%27invalid_scope%27.
&amp;state<span class="o">=</span>0b60fe50138f8fdd56afd2a6ab7a40f9
</code></pre></div>
<p><br>
The redirect request errors are normally resulted by a misconfiguration; therefore the error description in parameter <code>error_description</code> is not needed to be displayed for the user directly. The client application should check whether or not an error message has been sent.</p>
<h2 id='identity-token-request'>Identity token request</h2>
<p>The identity token request is an HTTP POST request which is used by the client application to request the identity token from the login server of eeID.</p>

<p>An example of an identity token request:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>POST https://auth.eeid.ee/hydra-public/oauth2/token
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content_Type: application/x-www-form-urlencoded
</code></pre></div><div class="highlight"><pre class="highlight shell tab-shell"><code><span class="nv">grant_type</span><span class="o">=</span>authorization_code&amp;
<span class="nv">code</span><span class="o">=</span>71ed5797c3d957817d31&amp;
<span class="nv">redirect_uri</span><span class="o">=</span>https%3A%2F%2Feservice.institution.ee%2Fcallback
</code></pre></div>
<p><br>
The client secret code must be provided in the identity token request. For this purpose, the request must include the <code>Authorization</code> request header with the value formed of the word Basic, a space and a string <code>&lt;client_id&gt;:&lt;client_secret&gt;</code> encoded in the Base64 format. The body of the HTTP POST request must be presented in a serialised <a href="https://openid.net/specs/openid-connect-core-1_0.html#FormSerialization">format</a> based on the OpenID Connect protocol. The body of the request must include the <code>code</code> received from the authentication service.</p>

<p>The body of the request must include the following parameters:</p>

<table><thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>grant_type</code></td>
<td>The <code>authorization_code</code> value required based on the protocol</td>
</tr>
<tr>
<td><code>code</code></td>
<td>The authorization code received from the authentication service</td>
</tr>
<tr>
<td><code>redirect_uri</code></td>
<td>The redirect URL sent in the authorisation request</td>
</tr>
</tbody></table>

<p>The server verifies that the identity token is requested by the right application and issues the identity token included in the response body. The response body uses JSON format consisting four elements:</p>

<table><thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>access_token</code></td>
<td>OAuth 2.0 access certificate. With access token the client application can issue authenticated user’s data from <code>userinfo</code> endpoint.</td>
</tr>
<tr>
<td><code>token_type</code></td>
<td>OAuth 2.0 access token type with bearer value</td>
</tr>
<tr>
<td><code>expires_in</code></td>
<td>The validity period of the OAuth 2.0 access token</td>
</tr>
<tr>
<td><code>id_token</code></td>
<td>Identity token. Presented in <a href="https://tools.ietf.org/html/rfc7515#section-3.1">JWS Compact Serialization</a> form</td>
</tr>
</tbody></table>

<p>The identity token is a certificate of the fact of authentication issued by eeID. The identity token is issued in <a href="https://jwt.io/">JSON Web Token</a>, JWT format. The identity token is always <a href="https://tools.ietf.org/html/rfc7515#section-5.2">signed</a>. Example:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0c597356-3771-4315-a129-c7bc1f02a1b2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://auth.eeid.ee"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oidc-b8ab3705-c25f-4271-b87d-ecf190aa4982-12"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530295852</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530267052</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530266752</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EE60001019906"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"profile_attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"date_of_birth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000-01-01"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"family_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"O’CONNEŽ-ŠUSLIK TESTNUMBER"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"given_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MARY ÄNN"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"amr"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"mID"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1OnH3qwltWy81fKqcmjYTqnco9yVQ2gGZXws/DBLNvQ="</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nonce"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"at_hash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"X0MVjwrmMQs/IBzfU2osvw=="</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p><br>
The following claims are presented in the identity token:</p>

<table><thead>
<tr>
<th>JSON element (claim)</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>jti</code></td>
<td>Identity token identifier</td>
</tr>
<tr>
<td><code>iss</code></td>
<td>Issuer of the certificate</td>
</tr>
<tr>
<td><code>aud</code></td>
<td>ID of a client application that requested authentication (the value of <code>client_id</code> field specified upon directing the user to the authentication process)</td>
</tr>
<tr>
<td><code>exp</code></td>
<td><code>1530295852</code> - expiration time of the certificate (in Unix epoch format)</td>
</tr>
<tr>
<td><code>iat</code></td>
<td><code>1530295852</code> - time of issue of the certificate (in Unix epoch format)</td>
</tr>
<tr>
<td><code>nbf</code></td>
<td><code>1530295852</code> - validity start time of the certificate (in Unix epoch format)</td>
</tr>
<tr>
<td><code>sub</code></td>
<td>The identifier of the authenticated user (personal identification code or eIDAS identifier) with the prefix of the country code of the citizen (country codes based on <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2#:~:text=ISO%203166%2D1%20alpha%2D2%20codes%20are%20two%2Dletter,special%20areas%20of%20geographical%20interest.">the ISO 3166-1 alpha-2 standard</a>).</td>
</tr>
<tr>
<td><code>profile_attributes</code></td>
<td>The data of the authenticated user, including the eIDAS attributes</td>
</tr>
<tr>
<td><code>profile_attributes.date_of_birth</code></td>
<td><code>2000-01-01</code> - the date of birth of the authenticated user in the ISO_8601 format.</td>
</tr>
<tr>
<td><code>profile_attributes.given_name</code></td>
<td>The first name of the authenticated user</td>
</tr>
<tr>
<td><code>profile_attributes.family_name</code></td>
<td>The surname of the authenticated user</td>
</tr>
<tr>
<td><code>amr</code></td>
<td>The authentication method used for user authentication. Example values: <code>mID</code> - Mobile-ID, <code>idcard</code> - Estonian ID card, <code>eIDAS</code> - cross-border, <code>smartid</code> - Smart-ID</td>
</tr>
<tr>
<td><code>acr</code></td>
<td><code>high</code> - level of authentication based on the eIDAS LoA (level of assurance). Possible values: <code>low</code>, <code>substantial</code>, <code>high</code></td>
</tr>
<tr>
<td><code>state</code></td>
<td>The authentication request&#39;s <code>state</code> parameter value</td>
</tr>
<tr>
<td><code>nonce</code></td>
<td>The authentication request&#39;s <code>nonce</code> parameter value. Value is present only in case the <code>nonce</code> parameter was sent in the authentication request</td>
</tr>
<tr>
<td><code>at_hash</code></td>
<td>The access token hash (not used)</td>
</tr>
<tr>
<td><code>email</code></td>
<td>The user&#39;s e-mail address (if present)</td>
</tr>
<tr>
<td><code>email_verified</code></td>
<td><code>false</code> - the e-mail address of the user has not been verified</td>
</tr>
<tr>
<td><code>phone_number</code></td>
<td><code>+37200000766</code> - the phone number is presented in E.164 format and prefixed by a country code (if present)</td>
</tr>
<tr>
<td><code>phone_number_verified</code></td>
<td><code>true</code> - the ownership of the phone number to the authenticating user has been confirmed</td>
</tr>
</tbody></table>

<p>Identity token might consist of other OpenID Connect protocol based fields that are not supported by eeID.</p>

<p>The client application must obtain the identity token immediately or within <code>30</code> seconds (before the expiry time of the identity token).</p>
<h2 id='user-info-request'>User info request</h2>
<p>User info request enables requesting information about an authenticated user based on a valid <code>OAuth 2.0</code> access token. The request must be done by using the HTTP GET method. The access token must be presented to the user info endpoint in the HTTP header by using <a href="https://tools.ietf.org/html/rfc6750#section-2.1">the Bearer Token method</a> or as a <a href="https://tools.ietf.org/html/rfc6750#section-2.3">URLi parameter</a>.</p>

<p>Example 1 - transferring an access certificate in the <code>Authorization</code> header:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>GET https://auth.eeid.ee/hydra-public/userinfo
Auhtorization: Bearer AT-20-qWuioSEtFhYVdW89JJ4yWvtI5SaNWep0
</code></pre></div>
<p><br>
Example 2 – transferring of access certificate as an <code>access_token</code> parameter:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>GET https://auth.eeid.ee/hydra-public/userinfo?access_token<span class="o">=</span>AT-20-qWuioSEtFhYVdW89JJ4yWvtI5SaNWep0
</code></pre></div>
<p><br>
The valid access token response is provided in the JSON format. Example:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"acr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"auth_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1694591147</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authentication_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SMART_ID"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"date_of_birth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000-01-01"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"family_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"O’CONNEŽ-ŠUSLIK TESTNUMBER"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"given_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MARY ÄNN"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EE60001019906"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p><br>
The claims included in the response are issued based on the identity token.</p>

<table><thead>
<tr>
<th>JSON element (claim)</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>auth_time</code></td>
<td>The time of successful authentication of the user</td>
</tr>
<tr>
<td><code>sub</code></td>
<td>The identifier of the authenticated user (personal identification code or eIDAS identifier) with the prefix of the country code of the citizen (country codes based on <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2#:~:text=ISO%203166%2D1%20alpha%2D2%20codes%20are%20two%2Dletter,special%20areas%20of%20geographical%20interest.">the ISO 3166-1 alpha-2 standard</a>)</td>
</tr>
<tr>
<td><code>authentication_type</code></td>
<td>The authentication method used for user authentication. Example values: <code>MOBILE_ID</code> - Mobile-ID, <code>ID_CARD</code> - Estonian ID card, <code>SMART_ID</code> - Smart-ID, <code>WEBAUTHN</code> - Fido Webauthn</td>
</tr>
<tr>
<td><code>acr</code></td>
<td><code>high</code> - level of authentication based on the eIDAS LoA (level of assurance). Possible values: <code>low</code>, <code>substantial</code>, <code>high</code></td>
</tr>
<tr>
<td><code>date_of_birth</code></td>
<td>The date of birth of the authenticated user in the ISO_8601 format</td>
</tr>
<tr>
<td><code>given_name</code></td>
<td>The first name of the authenticated user</td>
</tr>
<tr>
<td><code>family_name</code></td>
<td>The surname of the authenticated user</td>
</tr>
</tbody></table>

<p>Response body might contain other fields, that client application may ignore.</p>

<p>In case the access token presented to the user information endpoint is missing or is expired, an error code and a brief description 
about the error are returned:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"invalid_token"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"error_description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Token expired. Access token expired at '2022-10-07 14:55:34 +0000 UTC'."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h1 id='protection'>Protection</h1>
<p>The client application must implement protective measures against false request attacks (cross-site request forgery, CSRF). 
This can be achieved by using <code>state</code> security code. Using <code>state</code> is compulsory.</p>

<p>Using <code>state</code> with a cookie set on the client application side means that the client application itself does not have to remember the state parameter value. The process is described below.</p>

<p>The <code>state</code> security code is used to combat falsification of the redirect request following the authentication request. 
The client application must perform the following steps:</p>

<ol>
<li>Generate a random hexadecimal state session key, for example of the length of 32 characters: <code>07f19702e7e9591c6fa2554e1fcf5f4a</code> (referred to as <code>R</code>).</li>
<li>Add an order to set a cookie for the client application domain with a value of R immediately before making the authentication request, for example:</li>
</ol>

<p><code>Set-Cookie ESERVICE=07f19702e7e9591c6fa2554e1fcf5f4a; HttpOnly</code>
Where <code>ESERVICE</code> is a freely selected cookie name. The <code>HttpOnly</code> attribute must be applied to the cookie.</p>

<ol>
<li>Set the following value, in the authentication request, for the <code>state</code> parameter calculated based on section 1:</li>
</ol>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="nv">state</span><span class="o">=</span>07f19702e7e9591c6fa2554e1fcf5f4a
</code></pre></div>
<p><br>
Length of state parameter must be minimally 8 characters. In the course of processing the redirect request, the client application must:</p>

<ol>
<li>Take the <code>ESERVICE</code> value of the cookie received with the request.</li>
<li>Verify that the <code>ESERVICE</code> value matches the state value mirrored back in the redirect request.</li>
</ol>

<p>The redirect request may only be accepted if the checks described above are successful. 
The key element of the process described above is connection of the <code>state</code> value with the session. This is achieved by using a cookie.</p>
<h1 id='endpoints-and-timeouts'>Endpoints and timeouts</h1><h3 id='production-service'>Production service</h3>
<table><thead>
<tr>
<th>Endpoint</th>
<th>URL</th>
</tr>
</thead><tbody>
<tr>
<td>server discovery</td>
<td>https://auth.eeid.ee/hydra-public/.well-known/openid-configuration</td>
</tr>
<tr>
<td>public signature key</td>
<td>https://auth.eeid.ee/hydra-public/.well-known/jwks.json</td>
</tr>
<tr>
<td>authorization</td>
<td>https://auth.eeid.ee/hydra-public/oauth2/auth</td>
</tr>
<tr>
<td>token</td>
<td>https://auth.eeid.ee/hydra-public/oauth2/token</td>
</tr>
<tr>
<td>userinfo</td>
<td>https://auth.eeid.ee/hydra-public/userinfo</td>
</tr>
</tbody></table>
<h3 id='test-service'>Test service</h3>
<table><thead>
<tr>
<th>Endpoint</th>
<th>URL</th>
</tr>
</thead><tbody>
<tr>
<td>server discovery</td>
<td>https://test-auth.eeid.ee/hydra-public/.well-known/openid-configuration</td>
</tr>
<tr>
<td>public signature key</td>
<td>https://test-auth.eeid.ee/hydra-public/.well-known/jwks.json</td>
</tr>
<tr>
<td>authorization</td>
<td>https://test-auth.eeid.ee/hydra-public/oauth2/auth</td>
</tr>
<tr>
<td>token</td>
<td>https://test-auth.eeid.ee/hydra-public/oauth2/token</td>
</tr>
<tr>
<td>userinfo</td>
<td>https://test-auth.eeid.ee/hydra-public/userinfo</td>
</tr>
</tbody></table>
<h3 id='timeouts'>Timeouts</h3>
<table><thead>
<tr>
<th>Timeout</th>
<th>Value</th>
<th>Remark</th>
</tr>
</thead><tbody>
<tr>
<td>session</td>
<td>30 min</td>
<td>eeID server creates a session with the user identified. If the user doesn’t perform any activity on eeID page, the session will expire in 30 minutes. Note: eeID session must be distinguished from the session between the client application and the user.</td>
</tr>
<tr>
<td>SSL/TLS handshake</td>
<td>25 s</td>
<td>In case of ID-card authentication. The user must enter PIN1 within 25 seconds. After the timeout, the authentication will be terminated for security reasons.</td>
</tr>
<tr>
<td>Authorization code</td>
<td>30 s</td>
<td>The client application must obtain the access token using authorization code within 30 seconds.</td>
</tr>
</tbody></table>
<h1 id='testing'>Testing</h1>
<p>A prerequisite for testing the eeID authentication service is registering a service in test environment. After approving your service, it is possible to test the service immediately, using the credentials generated after approving.</p>

<p>Users for successful authentication:</p>

<ul>
<li>Mobile ID phone and id numbers: EE - <code>00000766</code> | <code>60001019906</code>, LT - <code>60000666</code> | <code>50001018865</code></li>
<li>Smart-ID personal codes: EE - <code>30303039914</code>, LV - <code>030303-10012</code>, LT - <code>30303039914</code></li>
<li>eIDAS country Czech Republic: select <code>Testovací profily</code> from the redirection screen and select a test user for authentication</li>
</ul>
<h3 id='mobile-id'>Mobile ID</h3>
<p>The eeID test environment is directed to the Mobiil-ID demo environment. Public test numbers are available for use:</p>

<ul>
<li>Test numbers are available <a href="https://github.com/SK-EID/MID/wiki/Test-number-for-automated-testing-in-DEMO">here</a>. Apply only Estonian (EE) test numbers and personal identification codes.</li>
</ul>
<h3 id='smart-id'>Smart ID</h3>
<p>The eeID test environment is directed to the Smart-ID demo environment. There are two options for use:</p>

<ul>
<li>Install the Smart-ID demo application on your device and register a <a href="https://github.com/SK-EID/smart-id-documentation/wiki/Smart-ID-demo#getting-started">demo account</a>.</li>
<li>Use <a href="https://github.com/SK-EID/smart-id-documentation/wiki/Environment-technical-parameters#test-accounts-for-automated-testing">test users</a>.</li>
</ul>
<h1 id='run-in-postman'>Run in Postman</h1>
<p><a href="https://god.gw.postman.com/run-collection/37760758-c07af2ef-c1d1-4675-91d1-701c0ea51871?action=collection%2Ffork&amp;source=rip_markdown&amp;collection-url=entityId%3D37760758-c07af2ef-c1d1-4675-91d1-701c0ea51871%26entityType%3Dcollection%26workspaceId%3Dfbfde0f7-54e9-4061-844a-5f03ab3d2ac4"><img src="https://run.pstmn.io/button.svg" alt="Run In Postman" style="width: 128px; height: 32px;"></a></p>
<h1 id='code-examples'>Code examples</h1><h2 id='openid-connect-client-with-spring-security'>OpenID Connect Client with Spring Security</h2>
<p>One of the key features of Spring Security 5 was the native support for OAuth2 and OIDC.
Making use of the OIDC configuration information (OIDC metadata), integrating with
the eeID Server gets super easy. This tutorial shows how to use a registered service to login via eeID and access the user details within an ID-token.</p>
<h3 id='prerequisites'>Prerequisites</h3>
<p>You should be familiar with Java, Spring Boot, and Spring Security.
Optionally, you should know how to use IntelliJ IDEA, but you can use any IDE of your choice.
Make sure you <a href="#getting-started">configure a service</a> in the <a href="https://eeid.ee">eeID manager</a> before getting started.</p>
<h3 id='setting-up-the-project'>Setting up the project</h3>
<ol>
<li>Visit <a href="https://start.spring.io/">start.spring.io</a> to create a new Spring Boot project</li>
<li>Select Maven as your build tool and Java as your language</li>
<li>Change the group to something meaningful and name your project</li>
<li>Choose JDK 17 (or the latest available)</li>
<li>Search for and add the following dependencies: Spring Security, OAuth2 Client, Spring Reactive Web, Thymeleaf</li>
</ol>

<p><img src="images/spring_initializr-a68a7971.png" alt="Spring Initializr" />
6. Generate the application. Spring Initializr creates an archive with a bootstrap application that includes the selected dependencies. Download and extract the archive, and import the project in an IDE of your choice</p>
<h3 id='add-a-starting-site'>Add a Starting Site</h3>
<p>Provide a starting site that is publicly available. Create the file <code>src/main/resources/templates/index.html</code>.
Add a link to the protected resource <code>/secured</code>.</p>
<div class="highlight"><pre class="highlight html tab-html"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Spring Boot eeID Demo<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Welcome<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/secured"</span><span class="nt">&gt;</span>Secured content<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div><h3 id='add-a-controller'>Add a Controller</h3>
<p>When the user logs in show the username. For that create a controller that handles
requests for the endpoint <code>/</code> and <code>/secured</code>. Create the file <code>src/main/java/com/example/demo/UserController.java</code>:</p>
<div class="highlight"><pre class="highlight java tab-java"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">index</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/secured"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">user</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">,</span>
                        <span class="nd">@AuthenticationPrincipal</span> <span class="nc">OidcUser</span> <span class="n">oidcUser</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"userName"</span><span class="o">,</span> <span class="n">oidcUser</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"audience"</span><span class="o">,</span> <span class="n">oidcUser</span><span class="o">.</span><span class="na">getAudience</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"secured"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p><br>
Create a template called <code>secured.html</code> next to <code>index.html</code>. Output the attributes for the username and client ID.</p>
<div class="highlight"><pre class="highlight html tab-html"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Spring Boot eeID Demo - Login<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;h1&gt;</span>Your Login Details<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div&gt;</span>
    Welcome <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"font-weight:bold"</span> <span class="na">th:text=</span><span class="s">"${userName}"</span><span class="nt">/&gt;</span>!
    You logged in at the OAuth 2.0 Client <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"font-weight:bold"</span> <span class="na">th:text=</span><span class="s">"${audience}"</span><span class="nt">/&gt;</span>.
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p><br>
With these routes in place, we can now set up our security configuration.</p>
<h3 id='protect-the-user-area'>Protect the User Area</h3>
<p>So far there are two unprotected endpoints: <code>/</code> and <code>/secured</code>.
Create another class, that enforces OAuth for certain paths. Create the file <code>src/main/java/com/example/demo/OAuth2SecurityConfig.java</code> with the following content:</p>
<div class="highlight"><pre class="highlight java tab-java"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebFluxSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2SecurityConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SecurityWebFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">ServerHttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeExchange</span><span class="o">(</span><span class="n">authorize</span> <span class="o">-&gt;</span> <span class="n">authorize</span>
                <span class="o">.</span><span class="na">pathMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"/error"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyExchange</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">oauth2Login</span><span class="o">(</span><span class="n">oauth2</span> <span class="o">-&gt;</span> <span class="n">oauth2</span>
                <span class="o">.</span><span class="na">authenticationMatcher</span><span class="o">(</span><span class="k">new</span> <span class="nc">PathPatternParserServerWebExchangeMatcher</span><span class="o">(</span><span class="s">"/login/oauth2/callback/{registrationId}"</span><span class="o">))</span>
            <span class="o">);</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p><br>
This enables and configures Spring Web Security.
The endpoints <code>/</code> and <code>/error</code> are public. Any other requests must be authenticated using OAuth.
Spring Security creates a default login page at <code>/login</code> that lists all the login options. </p>
<h3 id='configure-the-oauth-client'>Configure the OAuth Client</h3>
<p>Define the following client in <code>src/main/resources/application.yml</code>:</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">allow-bean-definition-overriding</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">demo</span>
  <span class="na">security</span><span class="pi">:</span>
    <span class="na">oauth2</span><span class="pi">:</span>
      <span class="na">client</span><span class="pi">:</span>
        <span class="na">registration</span><span class="pi">:</span>
          <span class="na">eeid</span><span class="pi">:</span>
            <span class="na">client-name</span><span class="pi">:</span> <span class="s">Login with the eeID</span>
            <span class="na">client-id</span><span class="pi">:</span> <span class="s">&lt;your-eeid-client-id&gt;</span>
            <span class="na">client-secret</span><span class="pi">:</span> <span class="s">&lt;your-eeid-secret&gt;</span>
            <span class="na">authorization-grant-type</span><span class="pi">:</span> <span class="s">authorization_code</span>
            <span class="na">redirect-uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{baseUrl}/login/oauth2/callback/{registrationId}"</span>
            <span class="na">scope</span><span class="pi">:</span> <span class="s">openid</span>
        <span class="na">provider</span><span class="pi">:</span>
          <span class="na">eeid</span><span class="pi">:</span>
            <span class="na">issuer-uri</span><span class="pi">:</span> <span class="s">https://test-auth.eeid.ee/hydra-public</span>
</code></pre></div>
<p><br>
This triggers Spring Boot to register a client. The client registration gets the id <code>eeid</code> which is part of the (default) <code>redirect-uri</code>.
The remaining properties, <code>client-id</code>, <code>client-secret</code> and <code>scope</code> have been defined when
configuring the client in the <a href="https://eeid.ee">eeID manager</a> (see <a href="#getting-started">Getting Started</a>). Make sure you configured correct callback url which is in our case must be <code>http://localhost:8080/login/oauth2/callback/eeid</code>.
You can choose any descriptive <code>client-name</code>. This is the string that is used in the default
login page setup at <code>/login</code>.
<br>
Spring Boot Security loads all the necessary OpenID configuration from the metadata
at <a href="https://test-auth.eeid.ee/hydra-public/.well-known/openid-configuration">https://test-auth.eeid.ee/hydra-public/.well-known/openid-configuration</a>
and ensures that the user-agent gets redirected to the right endpoints for authentication.</p>
<h3 id='run-the-demo-application'>Run the Demo Application</h3>
<p>Start the demo application with <code>mvn spring-boot:run</code>. Navigate to <code>http://localhost:8080</code> to access the index site.
Click on the link to access <code>http://localhost:8080/secured</code> that triggers a login.</p>

<p><img src="images/login_screen-c9e4a186.png" alt="Login Screen" />
<br>
After successful login the page shows details retrieved from the ID token.</p>

<p><img src="images/login_details-0eb274d4.png" alt="Login Details" />
<br>
You can also navigate to <code>http://localhost:8080/login</code> to directly access the default login page created by Spring Security.</p>

<p>For further examples and help regarding OAuth2 and Spring Security for a reactive web application visit <a href="https://docs.spring.io/spring-security/reference/reactive/oauth2/login/index.html">Spring Security Reference Documentation</a>.</p>
<h2 id='php-openid-connect-example'>PHP OpenID Connect example</h2>
<p>Make sure you <a href="#getting-started">configure a service</a> in the <a href="https://eeid.ee">eeID manager</a> before getting started.
<br>
This example uses the jumbojett basic OpenID Connect client and phpdotenv installed using composer and running on Docker container.</p>

<ul>
<li>jumbojett: <a href="https://github.com/jumbojett/OpenID-Connect-PHP">https://github.com/jumbojett/OpenID-Connect-PHP</a></li>
<li>phpdotenv: <a href="https://github.com/vlucas/phpdotenv">https://github.com/vlucas/phpdotenv</a></li>
<li>composer: <a href="https://getcomposer.org/">https://getcomposer.org/</a></li>
</ul>

<p>It takes users to an attributes page after login and display the claims/values that have been passed.
In the real world you would read the claims and feed them into your authorisation/user-session management process.</p>
<h3 id='instructions'>Instructions</h3>
<ol>
<li>Start by creating a new Dockerfile. This file will be used to build an image for your container. In the Dockerfile, include the following lines::</li>
</ol>
<div class="highlight"><pre class="highlight docker"><code><span class="k">FROM</span><span class="s"> php:7.4-apache</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"ServerName localhost"</span> <span class="o">&gt;&gt;</span> /etc/apache2/apache2.conf
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    zip <span class="se">\
</span>    unzip
<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php <span class="nt">--</span> <span class="nt">--install-dir</span><span class="o">=</span>/usr/local/bin <span class="nt">--filename</span><span class="o">=</span>composer
</code></pre></div>
<p><br>
This will use the <code>php:7.4-apache</code> image as the base for your container and install the necessary
dependencies for Composer (zip and unzip). It will then use curl to download the Composer
installer and run it to install Composer in the <code>/usr/local/bin</code> directory.
<br>
<br>
2. Create docker-compose.yml file in your project folder:</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.1'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">app</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8082:80"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">.:/var/www/html</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">APACHE_DOCUMENT_ROOT=/var/www/html</span>
</code></pre></div>
<p><br>
3. Create composer.json</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"jumbojett/openid-connect-php"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.8.0"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"vlucas/phpdotenv"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^5.3"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p><br>
4. Build the image and run a new container</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>dockder-compose up <span class="nt">--build</span>
</code></pre></div>
<p><br>
5. Run composer to read the composer.json file from the current directory, resolve the dependencies and install them into vendor:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>docker-compose run <span class="nt">--rm</span> app composer <span class="nb">install</span>
</code></pre></div>
<p><br>
6. Create a php page to handle the login, e.g. <code>index.php</code>.
This one creates a session attribute of an array of the returned claims and then passes the user
to an <code>attributes.php</code> page where they can be displayed.</p>
<div class="highlight"><pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>

<span class="k">require</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Jumbojett\OpenIDConnectClient</span><span class="p">;</span>

<span class="nv">$dotenv</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Dotenv\Dotenv</span><span class="o">::</span><span class="nf">createUnsafeImmutable</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">);</span>
<span class="nv">$dotenv</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">();</span>

<span class="nv">$issuer</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'ISSUER'</span><span class="p">);</span>
<span class="nv">$cid</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'OAUTH_CLIENT_ID'</span><span class="p">);</span>
<span class="nv">$secret</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'OAUTH_CLIENT_SECRET'</span><span class="p">);</span>
<span class="nv">$redirectUrl</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'CLIENT_REDIRECT_URI'</span><span class="p">);</span>
<span class="nv">$scope</span> <span class="o">=</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'SCOPE'</span><span class="p">);</span>

<span class="nv">$oidc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OpenIDConnectClient</span><span class="p">(</span><span class="nv">$issuer</span><span class="p">,</span> <span class="nv">$cid</span><span class="p">,</span> <span class="nv">$secret</span><span class="p">);</span>
<span class="nv">$oidc</span><span class="o">-&gt;</span><span class="nf">setRedirectURL</span><span class="p">(</span><span class="nv">$redirectUrl</span><span class="p">);</span>
<span class="nv">$oidc</span><span class="o">-&gt;</span><span class="nf">addScope</span><span class="p">(</span><span class="nv">$scope</span><span class="p">);</span>
<span class="nv">$oidc</span><span class="o">-&gt;</span><span class="nf">addAuthParam</span><span class="p">([</span><span class="s1">'ui_locales'</span> <span class="o">=&gt;</span> <span class="s1">'en'</span><span class="p">]);</span>

<span class="nv">$oidc</span><span class="o">-&gt;</span><span class="nf">authenticate</span><span class="p">();</span>

<span class="nv">$profile</span> <span class="o">=</span> <span class="nv">$oidc</span><span class="o">-&gt;</span><span class="nf">getVerifiedClaims</span><span class="p">(</span><span class="s1">'profile_attributes'</span><span class="p">);</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$profile</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">)){</span>
            <span class="nv">$v</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$session</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$v</span><span class="p">;</span>
<span class="p">}</span>


<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'attributes'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">;</span>

<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: ./attributes.php"</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div>
<p><br>
7. Create <code>.env</code> file with your OAuth client configuration parameters</p>
<div class="highlight"><pre class="highlight conf tab-conf"><code><span class="n">ISSUER</span>=<span class="s2">"https://test-auth.eeid.ee/hydra-public"</span>
<span class="n">OAUTH_CLIENT_ID</span>=<span class="s2">"&lt;your-eeid-client-id&gt;"</span>
<span class="n">OAUTH_CLIENT_SECRET</span>=<span class="s2">"&lt;your-eeid-secret&gt;"</span>
<span class="n">CLIENT_REDIRECT_URI</span>=<span class="s2">"http://localhost:8082/index.php"</span>
<span class="n">AUTHORIZATION_SERVER_AUTHORIZE_URL</span>=<span class="s2">"https://test-auth.eeid.ee/hydra-public/oauth2/auth"</span>
<span class="n">AUTHORIZATION_SERVER_ACCESS_TOKEN_URL</span>=<span class="s2">"https://test-auth.eeid.ee/hydra-public/oauth2/token"</span>
<span class="n">SCOPE</span>=<span class="s2">"openid"</span>
</code></pre></div>
<p><br>
Parameters like <code>OAUTH_CLIENT_ID</code>, <code>OAUTH_CLIENT_SECRET</code> and <code>SCOPE</code> have been defined after
configuring the service in the <a href="https://eeid.ee">eeID manager</a> (see <a href="#getting-started">Getting Started</a>).
<br>
8. Add the <code>attributes.php</code> page. E.g:</p>
<div class="highlight"><pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>
    <span class="nb">session_start</span><span class="p">();</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>

   <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
   <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>

   <span class="nt">&lt;title&gt;</span>OpenID Connect: Released Attributes<span class="nt">&lt;/title&gt;</span>

<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>

   <span class="c">&lt;!-- Intro --&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"banner"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>

         <span class="nt">&lt;h3&gt;</span>
            Claims sent back from OpenID Connect
         <span class="nt">&lt;/h3&gt;</span>
         <span class="nt">&lt;br/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/div&gt;</span>

   <span class="c">&lt;!-- Claims --&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content-section-a"</span> <span class="na">id=</span><span class="s">"openAthensClaims"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>

               <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table"</span> <span class="na">style=</span><span class="s">"width:80%;"</span> <span class="na">border = </span><span class="s">"1"</span><span class="nt">&gt;</span>
                 <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'attributes'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$value</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
                      <span class="nt">&lt;tr&gt;</span>
                          <span class="nt">&lt;td</span> <span class="na">data-toggle=</span><span class="s">"tooltip"</span> <span class="na">title=</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$key</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="err">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$key</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="s">&lt;/td</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;td</span> <span class="na">data-toggle=</span><span class="s">"tooltip"</span> <span class="na">title=</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$value</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="err">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$value</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="s">&lt;/td</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;/tr&gt;</span>
                 <span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>

               <span class="nt">&lt;/table&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p><br>
9. Go to <code>http://localhost:8082/index.php</code> in a browser. You will be sent to an eeID sign-in page.
After signing in you will be sent back and then on the attributes page.</p>

<p><img src="images/claims-a93acf58.png" alt="Claims" /></p>
<h2 id='rails-on-rails-with-omniauth-openidconnect'>Rails on Rails with OmniAuth::OpenIDConnect</h2>
<p>In this example, we will make use of <a href="https://github.com/omniauth/omniauth_openid_connect">OmniAuth::OpenIDConnect</a> gem, which contains the OpenID Connect (OIDC) strategy for OmniAuth library that standardizes multi-provider authentication for web applications.</p>
<h3 id='getting-started-2'>Getting Started</h3>
<p>Start by generating your Rails application with Bootstrap using ESBuild to build both the JavaScript and CSS files. From the terminal, run the command to do so:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>rails new eeid_demo <span class="nt">-T</span> <span class="nt">-j</span> esbuild <span class="nt">--css</span> bootstrap
</code></pre></div>
<p><br>
Create a partial named <code>_navigation.html.erb</code> to hold your navigation code. The partial should be located in the <code>app/views/layouts</code> directory. Enter the code below into an IDE. It uses Bootstrap to create a navigation bar for your application.</p>
<div class="highlight"><pre class="highlight erb tab-erb"><code><span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-lg bg-body-tertiary"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>eeID Demo<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-bs-toggle=</span><span class="s">"collapse"</span> <span class="na">data-bs-target=</span><span class="s">"#navbarNav"</span> <span class="na">aria-controls=</span><span class="s">"navbarNav"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbarNav"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Home'</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link active'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</code></pre></div>
<p><br>
For the navigation to be used, we need to render it in the application layout. Change application layout to look like this:</p>
<div class="highlight"><pre class="highlight erb tab-erb"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>eeID Demo<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csp_meta_tag</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbo-track"</span><span class="p">:</span> <span class="s2">"reload"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbo-track"</span><span class="p">:</span> <span class="s2">"reload"</span><span class="p">,</span> <span class="ss">defer: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"layouts/navigation"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">flash</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">flash_class</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p><br>
In order to display flash messages with the Bootstrap alert styles, extend <code>application_helper.rb</code> with the following method:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="k">def</span> <span class="nf">flash_class</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
  <span class="n">flash_classes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">notice: </span><span class="s1">'alert alert-info'</span><span class="p">,</span>
    <span class="ss">success: </span><span class="s1">'alert alert-success'</span><span class="p">,</span>
    <span class="ss">error: </span><span class="s1">'alert alert-error'</span><span class="p">,</span>
    <span class="ss">alert: </span><span class="s1">'alert alert-error'</span>
  <span class="p">}</span>

  <span class="n">flash_classes</span><span class="p">[</span><span class="n">level</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
Generate a <code>PagesController</code> with an index action by entering the command below into your terminal.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>rails generate controller Pages index
</code></pre></div>
<p><br>
In the index view generated, edit it to look like this:</p>
<div class="highlight"><pre class="highlight erb tab-erb"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to eeID Demo!<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
<p><br>
Open routes file to add our <code>root_path</code>:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># config/routes.rb</span>

Rails.application.routes.draw <span class="k">do
  </span>root to: <span class="s1">'pages#index'</span>
end
</code></pre></div><h3 id='setting-up-omniauth-tara'>Setting Up OmniAuth-Tara</h3>
<p>We need to create a new eeID service application. Go to <a href="https://eeid.ee">eeID manager</a> to create one. Enter all the necessary details:</p>

<p><img src="images/demo_service-8d14e8ca.png" alt="Demo Service" /></p>

<p>For the callback URL, enter your website&#39;s address plus <code>auth/eeid/callback</code>. If you happen to be on a local machine, your callback URL should be this: <code>http://127.0.0.1:3000/auth/eeid/callback</code></p>

<p>After submitting you will be redirected to the service information page. Copy the <code>Client ID</code> and <code>Client Secret</code> and paste them in a safe place — we will make use of them shortly.
The callback URL is the URL where a user will be redirected to inside the app after successful authentication and approved authorization (the request will also contain the user’s token). All OmniAuth strategies expect the callback URL to equal <code>/auth/:provider/callback</code>. <code>:provider</code> takes the name of the strategy. In our case, the strategy will be <code>eeid</code> as you will list in the initializer.</p>

<p>Open up Gemfile to add the necessary gems:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># Gemfile</span>
<span class="o">...</span>
<span class="n">gem</span> <span class="s1">'omniauth'</span><span class="p">,</span> <span class="s1">'&gt;=2.0.0'</span>
<span class="n">gem</span> <span class="s1">'omniauth_openid_connect'</span>
<span class="n">gem</span> <span class="s1">'omniauth-rails_csrf_protection'</span>
</code></pre></div>
<p><br>
Now create an initializer for OmniAuth in your config/initializers directory. This will hold the configuration for OmniAuth:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># config/initializers/omniauth.rb</span>

<span class="c1"># Block GET requests to avoid exposing self to CVE-2015-9284</span>
<span class="no">OmniAuth</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">allowed_request_methods</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:post</span><span class="p">]</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="ss">:openid_connect</span><span class="p">,</span> <span class="p">{</span>
    <span class="ss">name: :eeid</span><span class="p">,</span>
    <span class="ss">scope: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SCOPES'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">','</span><span class="p">),</span>
    <span class="ss">state: </span><span class="no">SecureRandom</span><span class="p">.</span><span class="nf">hex</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="ss">client_signing_alg: :RS256</span><span class="p">,</span>
    <span class="ss">send_scope_to_token_endpoint: </span><span class="kp">false</span><span class="p">,</span>
    <span class="ss">send_nonce: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">issuer: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'ISSUER'</span><span class="p">],</span>
    <span class="ss">discovery: </span><span class="kp">true</span><span class="p">,</span>

    <span class="ss">client_options: </span><span class="p">{</span>
      <span class="ss">identifier: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'IDENTIFIER'</span><span class="p">],</span>
      <span class="ss">secret: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'SECRET'</span><span class="p">],</span>
      <span class="ss">redirect_uri: </span><span class="no">ENV</span><span class="p">[</span><span class="s1">'REDIRECT_URL'</span><span class="p">],</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
We need to keep all the necesary private data safe as we do not want to push them to a public repository when we commit our code. We will make use of a <a href="https://github.com/bkeepers/dotenv">special gem</a> for this. Open Gemfile again and add the gem below. Add it to Gemfile like so:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># Gemfile</span>
<span class="o">...</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">...</span>
  <span class="n">gem</span> <span class="s1">'dotenv-rails'</span>
<span class="o">...</span>
</code></pre></div>
<p><br>
To install the gems, run:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>bundle <span class="nb">install</span>
</code></pre></div>
<p><br>
In the home directory create a file called <code>.env</code>.</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># .env</span>

<span class="no">ISSUER</span><span class="o">=</span><span class="s2">"https://test-auth.eeid.ee/hydra-public"</span>
<span class="no">IDENTIFIER</span><span class="o">=</span><span class="s2">"&lt;your-eeid-client-id&gt;"</span>
<span class="no">SECRET</span><span class="o">=</span><span class="s2">"&lt;your-eeid-secret&gt;"</span>
<span class="no">REDIRECT_URL</span><span class="o">=</span><span class="s2">"http://localhost:3000/auth/eeid/callback"</span>
<span class="no">SCOPES</span><span class="o">=</span><span class="s2">"openid"</span>
</code></pre></div>
<p><br>
Open <code>.gitignore</code> and add the file we just created.</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># .gitignore</span>
<span class="o">...</span>
<span class="c1"># Ignore .env used for storing id and secret</span>
<span class="p">.</span><span class="nf">env</span>
</code></pre></div>
<p><br>
Time to work on our routes. Open up the routes file and add the route below:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># config/routes.rb</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="o">...</span>
  <span class="n">get</span> <span class="s1">'/auth/:provider/callback'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sessions#create'</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
We need to add the link for eeID sign-in to navigation and to show this link only when the user is not signed in. Open navigation file and change it to look like this:</p>
<div class="highlight"><pre class="highlight erb tab-erb"><code><span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-lg bg-body-tertiary"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>eeID Demo<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-bs-toggle=</span><span class="s">"collapse"</span> <span class="na">data-bs-target=</span><span class="s">"#navbarNav"</span> <span class="na">aria-controls=</span><span class="s">"navbarNav"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbarNav"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Home'</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link active'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item nav-link"</span><span class="nt">&gt;</span>Signed in as <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">first_name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">button_to</span> <span class="s1">'Sign in with eeID'</span><span class="p">,</span> <span class="s1">'/auth/eeid'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">turbo: </span><span class="kp">false</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</code></pre></div><h3 id='creating-sessions'>Creating Sessions</h3>
<p>We&#39;ll need a session controller to handle the logging in of users. Create a file for that in controllers directory. The <code>create</code> action helps create a session for users so they can be logged into your application. Without this, users have no means of logging in.</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># app/controllers/sessions_controller.rb</span>

<span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_or_create_from_auth_hash</span><span class="p">(</span><span class="n">auth_hash</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Sucessfully logged in!'</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">auth_hash</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s1">'omniauth.auth'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
We&#39;ll need a <code>current_user</code> method at this point. This will help us check if a user is logged in or out.
Open <code>app/controllers/application_controller.rb</code> and add the following:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># app/controllers/application_controller.rb</span>

<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">helper_method</span> <span class="ss">:current_user</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div><h3 id='user-model'>User Model</h3>
<p>Now generate a model for Users. Run this command to do so:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>rails generate model User provider:string uid:string first_name:string last_name:string token:string
</code></pre></div>
<p><br>
That should generate a migration file that looks like this:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:provider</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:uid</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:first_name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:last_name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:token</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
Now migrate database by running:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>rake db:migrate
</code></pre></div>
<p><br>
Open up User model and make it look like this:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># app/models/user.rb</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_or_create_from_auth_hash</span><span class="p">(</span><span class="n">auth_hash</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="ss">provider: </span><span class="n">auth_hash</span><span class="p">.</span><span class="nf">provider</span><span class="p">,</span> <span class="ss">uid: </span><span class="n">auth_hash</span><span class="p">.</span><span class="nf">uid</span><span class="p">).</span><span class="nf">first_or_create</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span>
      <span class="ss">first_name: </span><span class="n">auth_hash</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">first_name</span><span class="p">,</span>
      <span class="ss">last_name: </span><span class="n">auth_hash</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">last_name</span><span class="p">,</span>
      <span class="ss">token: </span><span class="n">auth_hash</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">token</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
The code above stores some information belonging to the user. This includes the <code>first_name</code>, <code>last_name</code> and <code>token</code> of the user.</p>
<h3 id='deleting-sessions'>Deleting Sessions</h3>
<p>In our application, we want to provide users the ability to log out. We will need a <code>destroy</code> action in <code>SessionsController</code> for this to work. Then a link will be added to navigation.</p>

<p>Add the <code>destroy</code> action to <code>SessionsController</code>:</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># app/controllers/sessions_controller.rb</span>

<span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>  
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="k">if</span> <span class="n">current_user</span>
      <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Sucessfully logged out!"</span>
    <span class="k">end</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
Then add this link for logging out to navigation, so our navigation looks like this:</p>
<div class="highlight"><pre class="highlight erb tab-erb"><code><span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-lg bg-body-tertiary"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>eeID Demo<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-bs-toggle=</span><span class="s">"collapse"</span> <span class="na">data-bs-target=</span><span class="s">"#navbarNav"</span> <span class="na">aria-controls=</span><span class="s">"navbarNav"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbarNav"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Home'</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link active'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item nav-link"</span><span class="nt">&gt;</span>Signed in as <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">first_name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">button_to</span> <span class="s1">'Log Out'</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">turbo: </span><span class="kp">false</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">button_to</span> <span class="s1">'Sign in with eeID'</span><span class="p">,</span> <span class="s1">'/auth/eeid'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">turbo: </span><span class="kp">false</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</code></pre></div>
<p><br>
Open up <code>config/routes.rb</code> to update our routes with the action we just created.</p>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="o">...</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sessions#destroy'</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p><br>
Start up rails server and point browser to <a href="http://localhost:3000">http://localhost:3000</a>.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>bin/dev
</code></pre></div>
      </div>
    </div>
  </body>
</html>
